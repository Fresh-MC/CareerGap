<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="styles.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NoGap Dashboard - Security Policy Management</title>
    <script type="module" src="/main.js" defer></script>
  </head>

  <body>
    <div class="app">
      <header class="header">
        <div class="header-content">
          <h1>üõ°Ô∏è NoGap Dashboard</h1>
          <p class="subtitle">Security Policy Audit & Remediation</p>
        </div>
        <div class="system-info">
          <span id="system-info">Loading...</span>
        </div>
      </header>

      <main class="main-content">
        <div class="controls">
          <button id="load-policies-btn" class="btn btn-primary">Load Policies</button>
          <button id="audit-all-btn" class="btn btn-secondary" disabled>Audit All Policies</button>
          <button id="remediate-all-btn" class="btn btn-danger" disabled>Remediate All Policies</button>
          <button id="rollbackAllBtn" class="btn btn-warning" disabled>Rollback Last Change</button>
          <button id="generate-report-btn" class="btn btn-success">üìä Generate Report</button>
          <button id="export-csv-btn" class="btn btn-info">üìÑ Export CSV</button>
          <button id="import-csv-btn" class="btn btn-info">üì• Import CSV</button>
          <!-- AI-Assisted Features (Non-Agentic) -->
          <button id="risk-report-btn" class="btn btn-ai" disabled title="AI-Assisted Risk Analysis">üéØ Risk Report</button>
          <button id="drift-detect-btn" class="btn btn-ai" disabled title="AI-Assisted Drift Detection">üìâ Detect Drift</button>
          <button id="recommendations-btn" class="btn btn-ai" disabled title="AI-Assisted Policy Recommendations">üí° Get Recommendations</button>
          <div class="status-summary">
            <span id="policy-count">0 policies loaded</span>
            <span id="compliance-status"></span>
          </div>
        </div>

        <div class="filter-bar">
          <input type="text" id="search-input" placeholder="Search policies..." />
          <select id="platform-filter">
            <option value="all">All Platforms</option>
            <option value="windows">Windows</option>
            <option value="linux">Linux</option>
          </select>
          <select id="severity-filter">
            <option value="all">All Severities</option>
            <option value="critical">Critical</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
          <select id="status-filter">
            <option value="all">All Status</option>
            <option value="compliant">Compliant</option>
            <option value="non-compliant">Non-Compliant</option>
            <option value="pending">Pending</option>
          </select>
        </div>

        <!-- Autonomous Monitoring Section -->
        <div id="sensor-section" class="sensor-section">
          <div class="sensor-header">
            <h2>üîç Autonomous Monitoring</h2>
            <span class="sensor-badge" id="sensor-status-badge">Disabled</span>
          </div>
          <div class="sensor-content">
            <div class="sensor-controls">
              <div class="sensor-toggle-row">
                <label class="toggle-label">
                  <input type="checkbox" id="sensor-enabled-toggle" />
                  <span class="toggle-slider"></span>
                  Enable Autonomous Scanning
                </label>
              </div>
              <div class="sensor-interval-row">
                <label for="sensor-interval">Scan Interval:</label>
                <select id="sensor-interval">
                  <option value="1">Every 1 hour</option>
                  <option value="6">Every 6 hours</option>
                  <option value="12">Every 12 hours</option>
                  <option value="24" selected>Every 24 hours</option>
                  <option value="48">Every 48 hours</option>
                  <option value="168">Weekly</option>
                </select>
              </div>
              <div class="sensor-actions">
                <button id="sensor-start-btn" class="btn btn-success btn-small" disabled>‚ñ∂Ô∏è Start</button>
                <button id="sensor-stop-btn" class="btn btn-danger btn-small" disabled>‚èπÔ∏è Stop</button>
                <button id="sensor-scan-now-btn" class="btn btn-primary btn-small" disabled>üîÑ Scan Now</button>
              </div>
            </div>
            <div class="sensor-status-panel">
              <div class="sensor-status-item">
                <span class="status-label">Status:</span>
                <span id="sensor-running-status" class="status-value">Not Running</span>
              </div>
              <div class="sensor-status-item">
                <span class="status-label">Last Scan:</span>
                <span id="sensor-last-scan" class="status-value">Never</span>
              </div>
              <div class="sensor-status-item">
                <span class="status-label">Next Scan:</span>
                <span id="sensor-next-scan" class="status-value">--</span>
              </div>
            </div>
            <div class="sensor-summary-panel" id="sensor-summary-panel" style="display: none;">
              <h4>Last Scan Summary</h4>
              <div class="sensor-summary-grid">
                <div class="summary-stat">
                  <span class="stat-value" id="sensor-policies-checked">--</span>
                  <span class="stat-label">Policies Checked</span>
                </div>
                <div class="summary-stat stat-success">
                  <span class="stat-value" id="sensor-compliant-count">--</span>
                  <span class="stat-label">Compliant</span>
                </div>
                <div class="summary-stat stat-danger">
                  <span class="stat-value" id="sensor-non-compliant-count">--</span>
                  <span class="stat-label">Non-Compliant</span>
                </div>
                <div class="summary-stat stat-warning">
                  <span class="stat-value" id="sensor-drift-count">--</span>
                  <span class="stat-label">Drift Events</span>
                </div>
              </div>
              <button id="view-sensor-report-btn" class="btn btn-info btn-small">üìã View Full Report</button>
            </div>
          </div>
        </div>

        <!-- Remediation Planner Section -->
        <div id="planner-section" class="planner-section">
          <div class="planner-header">
            <h2>üìã Remediation Planner</h2>
            <span class="planner-badge" id="planner-status-badge">No Plan</span>
          </div>
          <div class="planner-notice">
            ‚ö†Ô∏è <strong>Proposed Plan Only</strong> ‚Äì No changes will be applied without explicit action
          </div>
          <div class="planner-content">
            <div class="planner-controls">
              <button id="generate-plan-btn" class="btn btn-primary">üìã Generate Remediation Plan</button>
              <button id="clear-plan-btn" class="btn btn-secondary btn-small" disabled>Clear Plan</button>
            </div>
            
            <!-- Plan Summary Card -->
            <div id="plan-summary-card" class="plan-summary-card" style="display: none;">
              <h3>Plan Summary</h3>
              <div class="plan-summary-grid">
                <div class="plan-summary-item">
                  <span class="plan-label">Goal:</span>
                  <span id="plan-goal" class="plan-value">--</span>
                </div>
                <div class="plan-summary-item">
                  <span class="plan-label">Snapshot:</span>
                  <span id="plan-snapshot-time" class="plan-value">--</span>
                </div>
                <div class="plan-summary-item">
                  <span class="plan-label">Compliance Rate:</span>
                  <span id="plan-compliance-rate" class="plan-value">--</span>
                </div>
                <div class="plan-summary-item">
                  <span class="plan-label">Generated:</span>
                  <span id="plan-generated-at" class="plan-value">--</span>
                </div>
              </div>
              <div class="plan-stats-row">
                <div class="plan-stat">
                  <span class="plan-stat-value" id="plan-steps-count">0</span>
                  <span class="plan-stat-label">Steps</span>
                </div>
                <div class="plan-stat plan-stat-warning">
                  <span class="plan-stat-value" id="plan-deferred-count">0</span>
                  <span class="plan-stat-label">Deferred</span>
                </div>
                <div class="plan-stat plan-stat-info">
                  <span class="plan-stat-value" id="plan-candidates-count">0</span>
                  <span class="plan-stat-label">Candidates</span>
                </div>
              </div>
              <!-- Modified indicator -->
              <div id="plan-modified-notice" class="plan-modified-notice" style="display: none;">
                ‚úèÔ∏è <strong>Modified by User</strong> ‚Äì Plan has been edited from original proposal
              </div>
              <div class="plan-approval-row">
                <div class="approval-status" id="plan-approval-status">
                  <span class="approval-icon">üîí</span>
                  <span>Human Approval Required</span>
                </div>
                <button id="approve-plan-btn" class="btn btn-success">‚úÖ Approve Plan</button>
              </div>
            </div>

            <!-- Plan Steps View -->
            <div id="plan-steps-section" class="plan-steps-section" style="display: none;">
              <div class="plan-section-header">
                <h3>üìù Proposed Steps <span class="step-count-badge" id="steps-badge">0</span></h3>
                <button id="add-policy-btn" class="btn btn-outline btn-small">+ Add Policy to Plan</button>
              </div>
              <div id="plan-steps-list" class="plan-steps-list">
                <!-- Steps will be populated by JavaScript -->
              </div>
            </div>

            <!-- Manually Excluded Policies -->
            <div id="plan-excluded-section" class="plan-excluded-section" style="display: none;">
              <h3>üö´ Manually Excluded <span class="excluded-count-badge" id="excluded-badge">0</span></h3>
              <p class="excluded-explanation">These policies were removed by the user.</p>
              <div id="plan-excluded-list" class="plan-excluded-list">
                <!-- Excluded policies will be populated by JavaScript -->
              </div>
            </div>

            <!-- Deferred Policies View -->
            <div id="plan-deferred-section" class="plan-deferred-section" style="display: none;">
              <h3>‚è∏Ô∏è Deferred Policies <span class="deferred-count-badge" id="deferred-badge">0</span></h3>
              <p class="deferred-explanation">These policies were excluded from the plan due to blocking constraints.</p>
              <div id="plan-deferred-list" class="plan-deferred-list">
                <!-- Deferred policies will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
          <div class="spinner"></div>
          <p>Processing...</p>
        </div>

        <div id="policies-container" class="policies-container">
          <div class="empty-state">
            <p>Click "Load Policies" to begin</p>
          </div>
        </div>
      </main>

      <footer class="footer">
        <p>NoGap Security Policy Manager | Built with Tauri & Rust</p>
      </footer>
    </div>

    <!-- Policy Detail Modal -->
    <div id="policy-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modal-title"></h2>
        <div id="modal-body"></div>
        <div class="modal-actions">
          <button id="rollbackOneBtn" class="btn btn-warning btn-small" style="display: none;">Rollback This Policy</button>
        </div>
      </div>
    </div>

    <!-- Report Preview Modal -->
    <div id="report-modal" class="modal" style="display: none;">
      <div class="modal-content modal-content-large">
        <span class="report-close">&times;</span>
        <h2>üìä Compliance Report Preview</h2>
        <div class="report-preview-container">
          <iframe id="report-preview-frame" title="Report Preview"></iframe>
        </div>
        <div class="modal-actions">
          <button id="export-pdf-btn" class="btn btn-success" disabled>üñ®Ô∏è Export as PDF</button>
          <button class="btn btn-secondary" onclick="closeReportModal()">Close</button>
        </div>
      </div>
    </div>

    <!-- AI-Assisted Risk Report Modal -->
    <div id="risk-report-modal" class="modal" style="display: none;">
      <div class="modal-content modal-content-large">
        <span class="risk-close">&times;</span>
        <h2>üéØ AI-Assisted Risk Report</h2>
        <p class="ai-disclaimer">‚ö†Ô∏è AI-Assisted Analysis - Review before taking action</p>
        <div id="risk-report-content">
          <div class="risk-summary">
            <div class="risk-score-card">
              <h3>Aggregate Risk Score</h3>
              <div id="aggregate-risk-score" class="risk-score-value">--</div>
            </div>
            <div class="risk-stats">
              <div><span id="total-policies-count">--</span> Total Policies</div>
              <div><span id="compliant-count" class="text-success">--</span> Compliant</div>
              <div><span id="non-compliant-count" class="text-danger">--</span> Non-Compliant</div>
            </div>
          </div>
          <h3>Top 10 Risk Priorities</h3>
          <div id="top-risks-list" class="risks-list"></div>
        </div>
      </div>
    </div>

    <!-- AI-Assisted Drift Detection Modal -->
    <div id="drift-modal" class="modal" style="display: none;">
      <div class="modal-content modal-content-large">
        <span class="drift-close">&times;</span>
        <h2>üìâ AI-Assisted Compliance Drift Detection</h2>
        <p class="ai-disclaimer">‚ö†Ô∏è AI-Assisted Analysis - Compares against previous audit snapshot</p>
        <div id="drift-content">
          <div class="drift-summary">
            <p id="drift-summary-text"></p>
          </div>
          <h3>Drift Events (Compliant ‚Üí Non-Compliant)</h3>
          <div id="drift-events-list" class="drift-list"></div>
        </div>
      </div>
    </div>

    <!-- AI-Assisted Recommendations Modal -->
    <div id="recommendations-modal" class="modal" style="display: none;">
      <div class="modal-content modal-content-large">
        <span class="recommendations-close">&times;</span>
        <h2>üí° AI-Assisted Policy Recommendations</h2>
        <p class="ai-disclaimer">‚ö†Ô∏è AI-Assisted Suggestions - Review each policy before enabling</p>
        <div class="recommendations-form">
          <label for="role-input">System Role:</label>
          <input type="text" id="role-input" placeholder="e.g., web server, database, workstation" />
          <label for="environment-input">Environment:</label>
          <select id="environment-input">
            <option value="production">Production</option>
            <option value="development">Development</option>
            <option value="staging">Staging</option>
            <option value="air-gapped">Air-Gapped</option>
          </select>
          <button id="get-recommendations-btn" class="btn btn-primary">Get Recommendations</button>
        </div>
        <div id="recommendations-content">
          <p id="recommendations-context"></p>
          <div id="recommendations-list" class="recommendations-list"></div>
        </div>
      </div>
    </div>

    <!-- Autonomous Sensor Report Modal -->
    <div id="sensor-report-modal" class="modal" style="display: none;">
      <div class="modal-content modal-content-large">
        <span class="sensor-report-close">&times;</span>
        <h2>üìã Autonomous Scan Report</h2>
        <p class="sensor-label">üîç Autonomous Scan - Read-Only Report</p>
        <div id="sensor-report-content">
          <div class="sensor-report-header">
            <p><strong>Scan Time:</strong> <span id="report-scan-time">--</span></p>
            <p><strong>Source:</strong> <span class="sensor-source-tag">Autonomous Sensor</span></p>
          </div>
          <div class="sensor-report-summary">
            <div class="report-stat">
              <span class="report-stat-value" id="report-policies-total">--</span>
              <span class="report-stat-label">Total Policies</span>
            </div>
            <div class="report-stat report-stat-success">
              <span class="report-stat-value" id="report-compliant">--</span>
              <span class="report-stat-label">Compliant</span>
            </div>
            <div class="report-stat report-stat-danger">
              <span class="report-stat-value" id="report-non-compliant">--</span>
              <span class="report-stat-label">Non-Compliant</span>
            </div>
          </div>
          <h3>Audit Results</h3>
          <div id="sensor-report-results" class="sensor-report-results"></div>
        </div>
      </div>
    </div>

    <!-- Planner Step Detail Modal -->
    <div id="planner-step-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="planner-step-close">&times;</span>
        <h2>üìã Step Details</h2>
        <div class="step-detail-content">
          <div class="step-detail-header">
            <span class="step-priority-badge" id="step-detail-priority">#1</span>
            <span class="step-policy-id" id="step-detail-policy-id">--</span>
          </div>
          <div class="step-detail-grid">
            <div class="step-detail-item">
              <span class="detail-label">Risk Score:</span>
              <span class="detail-value risk-score" id="step-detail-risk">--</span>
            </div>
            <div class="step-detail-item">
              <span class="detail-label">Confidence:</span>
              <span class="detail-value confidence" id="step-detail-confidence">--</span>
            </div>
            <div class="step-detail-item">
              <span class="detail-label">Est. Duration:</span>
              <span class="detail-value" id="step-detail-duration">--</span>
            </div>
            <div class="step-detail-item">
              <span class="detail-label">Expected Impact:</span>
              <span class="detail-value" id="step-detail-impact">--</span>
            </div>
          </div>
          <div class="step-detail-reason">
            <span class="detail-label">Reason:</span>
            <p id="step-detail-reason-text">--</p>
          </div>
          <div class="step-detail-constraints">
            <span class="detail-label">Constraints Considered:</span>
            <div id="step-detail-constraints-list" class="constraints-tags">
              <!-- Constraints will be populated -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Policy to Plan Modal -->
    <div id="add-policy-modal" class="modal" style="display: none;">
      <div class="modal-content modal-content-medium">
        <span class="modal-close" onclick="closeAddPolicyModal()">&times;</span>
        <h2>‚ûï Add Policy to Plan</h2>
        <p class="modal-description">Search for policies to add to the remediation plan.</p>
        
        <div class="policy-search-container">
          <input type="text" id="policy-search-input" class="policy-search-input" 
                 placeholder="Search by policy ID or keyword..." 
                 oninput="filterEligiblePolicies()">
          <div class="policy-filter-row">
            <label class="filter-checkbox">
              <input type="checkbox" id="filter-non-compliant" checked onchange="filterEligiblePolicies()">
              <span>Show Non-Compliant Only</span>
            </label>
          </div>
        </div>
        
        <div id="eligible-policies-list" class="eligible-policies-list">
          <p class="loading-text">Loading policies...</p>
        </div>
        
        <div class="modal-footer">
          <span class="hard-constraint-notice">‚ö†Ô∏è Policies with hard constraints (platform mismatch) cannot be added.</span>
        </div>
      </div>
    </div>

    <!-- Plan Modification Acknowledgment Modal -->
    <div id="plan-ack-modal" class="modal" style="display: none;">
      <div class="modal-content modal-content-small">
        <h2>‚ö†Ô∏è Modified Plan Approval</h2>
        <p>This plan has been modified from the original system proposal.</p>
        <div class="modification-summary" id="modification-summary">
          <!-- Summary will be populated -->
        </div>
        <p class="ack-warning">By approving, you acknowledge these user modifications.</p>
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeAckModal()">Cancel</button>
          <button class="btn btn-success" onclick="confirmApproval()">‚úÖ Confirm Approval</button>
        </div>
      </div>
    </div>
  </body>
</html>